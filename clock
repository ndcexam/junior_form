<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ± - Â∞àÊ•≠ÁöÑËÄÉË©¶ÊôÇÈñìÁÆ°ÁêÜÂ∑•ÂÖ∑">
    <meta name="keywords" content="ËÄÉË©¶, Â†±ÊôÇ, ÊèêÈÜí, ÊôÇÈñìÁÆ°ÁêÜ, Â≠∏Ê†°">
    <meta name="author" content="Examination Timing Alert System">
   
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
   
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./images/favicon.png">
   
    <title>ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ±</title>
   
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- TailwindCSS Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E3A8A',
                        secondary: '#374151',
                        accent: '#D97706',
                        warning: '#D97706',
                        surface: '#F8FAFC',
                        'surface-dark': '#0F172A'
                    },
                    fontFamily: {
                        'mono': ['Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>
   
    <!-- Custom Styles -->
    <style>
        /* Animation Styles */
        .warning-flash {
            animation: flash 2s infinite;
        }
       
        @keyframes flash {
            0%, 50% {
                background-color: #FEF3C7;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #F59E0B;
                border-color: #92400E;
            }
        }
       
        .dark .warning-flash {
            animation: flash-dark 2s infinite;
        }
       
        @keyframes flash-dark {
            0%, 50% {
                background-color: #92400E;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #B45309;
                border-color: #F59E0B;
            }
        }
       
        .urgent-flash {
            animation: urgent 1s infinite;
        }
       
        @keyframes urgent {
            0%, 50% {
                background-color: #FEF3C7;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #F59E0B;
                border-color: #92400E;
            }
        }
       
        .dark .urgent-flash {
            animation: urgent-dark 1s infinite;
        }
       
        @keyframes urgent-dark {
            0%, 50% {
                background-color: #92400E;
                border-color: #D97706;
            }
            51%, 100% {
                background-color: #B45309;
                border-color: #F59E0B;
            }
        }
       
        /* Enhanced Visual Effects */
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
       
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.95);
        }
       
        .time-display {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            min-height: 1.5rem;
            display: flex;
            align-items: center;
        }
       
        .dark .time-display {
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        }
       
        /* Time Input Display */
        .time-input-display {
            cursor: pointer;
            transition: all 0.2s ease;
        }
       
        .time-input-display:hover {
            background-color: #F1F5F9;
            border-color: #1E3A8A;
        }
       
        .dark .time-input-display:hover {
            background-color: #475569;
            border-color: #3B82F6;
        }
       
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
       
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
       
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            max-width: 400px;
            width: 90%;
        }
       
        .dark .modal-content {
            background: #1e293b;
            border: 1px solid #475569;
        }
       
        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
        }
       
        /* Time Picker Styles */
        .time-picker {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin: 1.5rem 0;
        }
       
        .time-input {
            width: 80px;
            height: 60px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            font-family: monospace;
            font-weight: bold;
        }
       
        .dark .time-input {
            background: #374151;
            border-color: #6b7280;
            color: white;
        }
       
        .time-input:focus {
            outline: none;
            border-color: #1E3A8A;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
       
        .time-separator {
            font-size: 2rem;
            font-weight: bold;
            color: #64748b;
        }
       
        .dark .time-separator {
            color: #94a3b8;
        }
       
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
           
            .dark .warning-flash,
            .dark .urgent-flash {
                background-color: #92400E !important;
            }
           
            .modal-overlay,
            .modal-content {
                transition: none;
            }
        }
       
        /* Print Styles */
        @media print {
            .warning-flash,
            .urgent-flash {
                animation: none;
                background-color: #FEF3C7 !important;
            }
           
            body {
                background: white !important;
                color: black !important;
            }
           
            .modal-overlay {
                display: none !important;
            }
        }
       
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 640px) {
            .time-display {
                font-size: 3rem !important;
            }
           
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
           
            .time-picker {
                flex-direction: column;
                gap: 0.5rem;
            }
           
            .time-input {
                width: 100px;
                height: 50px;
                font-size: 1.25rem;
            }
        }
       
        /* Focus Indicators */
        input:focus,
        button:focus {
            outline: 2px solid #1E3A8A;
            outline-offset: 2px;
        }
       
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-slate-100 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen font-sans">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-4 py-2 rounded">
        Ë∑≥Ëá≥‰∏ªË¶ÅÂÖßÂÆπ
    </a>

    <!-- Header -->
    <header class="bg-primary dark:bg-slate-800 border-b-4 border-accent shadow-lg">
        <div class="container mx-auto p-6 max-w-7xl">
            <div class="flex items-center justify-center gap-6">
                <img
                    src="./images/NDC_school_logov2.png"
                    alt="Â≠∏Ê†°Ê†°ÂæΩ"
                    class="h-16 w-16 object-contain"
                    loading="eager"
                    onerror="this.style.display='none'"
                >
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white tracking-wider">
                        ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ±
                    </h1>
                    <p class="text-blue-100 dark:text-slate-300 mt-2 text-lg">
                        EXAMINATION TIMING ALERT SYSTEM
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-6 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-[25%_25%_50%] gap-8">
           
            <!-- Time Configuration Panel -->
            <section class="order-1 lg:order-1" aria-labelledby="config-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg h-full">
                    <header class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600 rounded-t-lg">
                        <h2 id="config-title" class="text-xl font-bold text-center tracking-wide">
                            ËÄÉË©¶ÊôÇÈñìË®≠ÂÆö
                        </h2>
                        <p class="text-center text-slate-200 text-sm mt-1">
                            EXAM TIME CONFIGURATION
                        </p>
                    </header>
                   
                    <div class="p-6">
                        <!-- Form 1 Configuration -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">
                                    ‰∏≠‰∏ÄÂπ¥Á¥ö FORM 1
                                </h3>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form1End1Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form1End1')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠‰∏ÄÂπ¥Á¥öÁ¨¨‰∏ÄÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form1End2Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form1End2')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠‰∏ÄÂπ¥Á¥öÁ¨¨‰∫åÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form 2 Configuration -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">
                                    ‰∏≠‰∫åÂπ¥Á¥ö FORM 2
                                </h3>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form2End1Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form2End1')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠‰∫åÂπ¥Á¥öÁ¨¨‰∏ÄÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form2End2Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form2End2')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠‰∫åÂπ¥Á¥öÁ¨¨‰∫åÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form 3 Configuration -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">
                                    ‰∏≠‰∏âÂπ¥Á¥ö FORM 3
                                </h3>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form3End1Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form3End1')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠‰∏âÂπ¥Á¥öÁ¨¨‰∏ÄÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form3End2Display"
                                     class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded time-input-display"
                                     onclick="TimePickerModal.open('form3End2')"
                                     role="button"
                                     tabindex="0"
                                     aria-label="Ë®≠ÂÆö‰∏≠‰∏âÂπ¥Á¥öÁ¨¨‰∫åÁØÄËÄÉË©¶ÁµêÊùüÊôÇÈñì">
                                    <div class="text-base font-bold font-mono tracking-wider time-display">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Time Display Panel -->
            <section class="order-1 lg:order-2" aria-labelledby="remaining-title">
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg h-full">
                    <header class="bg-secondary text-white p-4 border-b-2 border-slate-300 dark:border-slate-600 rounded-t-lg">
                        <h2 id="remaining-title" class="text-xl font-bold text-center tracking-wide">
                            Ââ©È§òÊôÇÈñì
                        </h2>
                        <p class="text-center text-slate-200 text-sm mt-1">
                            REMAINING TIME
                        </p>
                    </header>
                   
                    <div class="p-6">
                        <!-- Form 1 Times -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">‰∏≠‰∏ÄÂπ¥Á¥ö FORM 1</h3>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form1Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form1Session1Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form1Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form1Session2Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form 2 Times -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">‰∏≠‰∫åÂπ¥Á¥ö FORM 2</h3>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form2Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form2Session1Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form2Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form2Session2Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form 3 Times -->
                        <div class="mb-8">
                            <div class="bg-slate-100 dark:bg-slate-700 p-3 mb-4 border-l-4 border-primary rounded">
                                <h3 class="text-lg font-bold text-primary dark:text-blue-300">‰∏≠‰∏âÂπ¥Á¥ö FORM 3</h3>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∏ÄÁØÄ SESSION 1</div>
                                <div id="form3Session1" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form3Session1Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                           
                            <div class="mb-4">
                                <div class="text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Á¨¨‰∫åÁØÄ SESSION 2</div>
                                <div id="form3Session2" class="py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded" role="timer" aria-live="polite">
                                    <div id="form3Session2Time" class="text-base font-bold font-mono tracking-wider time-display">--:--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clock and Alerts Panel -->
            <section class="order-3 lg:order-3">
                <!-- Current Time Display -->
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl mb-8 rounded-lg">
                    <header class="bg-primary text-white p-4 border-b-2 border-blue-800 rounded-t-lg">
                        <h2 class="text-xl font-bold text-center tracking-wide">È¶ôÊ∏ØÊ®ôÊ∫ñÊôÇÈñì</h2>
                        <p class="text-center text-blue-100 text-sm mt-1">HONG KONG STANDARD TIME</p>
                    </header>
                    <div class="p-8 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-b-lg">
                        <div class="text-center">
                            <time
                                id="currentTime"
                                class="text-6xl xl:text-7xl font-bold font-mono text-primary dark:text-blue-300 time-display tracking-wider mb-4 block"
                                role="timer"
                                aria-live="polite"
                            ></time>
                            <div id="currentDate" class="text-lg text-slate-600 dark:text-slate-400 font-medium"></div>
                        </div>
                    </div>
                </div>
               
                <!-- System Alerts -->
                <div class="bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 shadow-xl rounded-lg">
                    <header class="bg-accent text-white p-4 border-b-2 border-yellow-800 rounded-t-lg">
                        <h3 class="text-xl font-bold text-center tracking-wide">Á≥ªÁµ±ÊèêÈÜí</h3>
                        <p class="text-center text-yellow-100 text-sm mt-1">SYSTEM ALERTS</p>
                    </header>
                    <div class="p-6">
                        <div id="alertsList" class="space-y-3" role="log" aria-live="polite" aria-label="Á≥ªÁµ±ÊèêÈÜíÂàóË°®">
                            <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                                <div class="text-lg font-semibold">Êö´ÁÑ°ÊèêÈÜí</div>
                                <div class="text-sm mt-1">NO ALERTS</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
       
        <!-- Control Buttons Section -->
        <div class="mt-8 text-center space-y-4">
            <!-- Audio Test Button -->
            <div>
                <button
                    onclick="testAudioSystem()"
                    class="bg-accent hover:bg-yellow-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-accent hover:border-yellow-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-accent mr-4"
                    aria-describedby="audio-test-desc"
                >
                    üéµ Ê∏¨Ë©¶Èü≥ÊïàÁ≥ªÁµ± TEST AUDIO
                </button>
                <span id="audio-test-desc" class="sr-only">Ê∏¨Ë©¶Èü≥ÊïàÊí≠ÊîæÂäüËÉΩ</span>
               
                <!-- Audio Status Indicator -->
                <div id="audioStatus" class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                    <span id="audioStatusText">Èü≥ÊïàÁ≥ªÁµ±ÔºöÊú™ÂàùÂßãÂåñ</span>
                </div>
            </div>
           
            <!-- Reset Button -->
            <div>
                <button
                    onclick="resetAllTimes()"
                    class="bg-secondary hover:bg-slate-600 text-white py-3 px-8 font-semibold tracking-wide uppercase transition-colors border-2 border-secondary hover:border-slate-600 rounded-lg shadow-lg hover:shadow-xl focus:ring-2 focus:ring-offset-2 focus:ring-secondary"
                    aria-describedby="reset-desc"
                >
                    ÈáçÁΩÆÊâÄÊúâË®≠ÂÆö RESET ALL
                </button>
                <span id="reset-desc" class="sr-only">Ê∏ÖÈô§ÊâÄÊúâÊôÇÈñìË®≠ÂÆö</span>
            </div>
        </div>
    </main>

    <!-- Time Picker Modal -->
    <div id="timePickerModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-center mb-4 text-slate-900 dark:text-slate-100">Ë®≠ÂÆöËÄÉË©¶ÁµêÊùüÊôÇÈñì</h3>
           
            <div class="time-picker">
                <div>
                    <label for="hourInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">Â∞èÊôÇ</label>
                    <input type="number" id="hourInput" class="time-input" min="0" max="23" placeholder="HH">
                </div>
               
                <div class="time-separator">:</div>
               
                <div>
                    <label for="minuteInput" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 text-center">ÂàÜÈêò</label>
                    <input type="number" id="minuteInput" class="time-input" min="0" max="59" placeholder="MM">
                </div>
            </div>
           
            <div class="flex gap-3 justify-center mt-6">
                <button onclick="TimePickerModal.save()" class="bg-primary hover:bg-blue-800 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    Á¢∫ÂÆö
                </button>
                <button onclick="TimePickerModal.clear()" class="bg-warning hover:bg-yellow-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-warning">
                    Ê∏ÖÈô§
                </button>
                <button onclick="TimePickerModal.close()" class="bg-slate-500 hover:bg-slate-600 text-white px-6 py-2 rounded font-medium transition-colors focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                    ÂèñÊ∂à
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden input fields for backwards compatibility -->
    <div style="display: none;">
        <input type="time" id="form1End1">
        <input type="time" id="form1End2">
        <input type="time" id="form2End1">
        <input type="time" id="form2End2">
        <input type="time" id="form3End1">
        <input type="time" id="form3End2">
    </div>

    <!-- JavaScript Application -->
    <script>
        'use strict';
       
        // Application State
        const AppState = {
            alertHistory: new Set(),
            timeAlertHistory: new Set(),
            isPlayingAudio: false,
            timers: new Map(),
            examTimes: {
                form1End1: '',
                form1End2: '',
                form2End1: '',
                form2End2: '',
                form3End1: '',
                form3End2: ''
            },
            // üéØ Êñ∞Â¢ûÔºöÈ†êËôïÁêÜÁöÑÈü≥ÊïàÊôÇÈñìË°®
            audioSchedule: new Map(), // timestamp -> audioSequence
            scheduleBuilt: false
        };

        // Time Picker Modal
        const TimePickerModal = {
            currentField: null,
           
            open(fieldId) {
                this.currentField = fieldId;
                const modal = document.getElementById('timePickerModal');
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
               
                // Get current time value
                const currentTime = AppState.examTimes[fieldId];
                if (currentTime) {
                    const [hours, minutes] = currentTime.split(':');
                    hourInput.value = parseInt(hours).toString();
                    minuteInput.value = parseInt(minutes).toString();
                } else {
                    hourInput.value = '';
                    minuteInput.value = '';
                }
               
                modal.classList.add('show');
               
                // Focus first input
                setTimeout(() => {
                    hourInput.focus();
                }, 100);
               
                // Add keyboard listeners
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
            },
           
            close() {
                const modal = document.getElementById('timePickerModal');
                modal.classList.remove('show');
                this.currentField = null;
               
                // Remove keyboard listeners
                document.removeEventListener('keydown', this.handleKeyDown.bind(this));
            },
           
            async save() {
                const hourInput = document.getElementById('hourInput');
                const minuteInput = document.getElementById('minuteInput');
               
                let hours = parseInt(hourInput.value) || 0;
                let minutes = parseInt(minuteInput.value) || 0;
               
                // Validate input
                if (hours < 0 || hours > 23) {
                    this.showValidationMessage('Â∞èÊôÇÂøÖÈ†àÂú® 0-23 ‰πãÈñì');
                    hourInput.focus();
                    return;
                }
               
                if (minutes < 0 || minutes > 59) {
                    this.showValidationMessage('ÂàÜÈêòÂøÖÈ†àÂú® 0-59 ‰πãÈñì');
                    minuteInput.focus();
                    return;
                }
               
                // Format time
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
               
                // üéµ Initialize Web Audio API on user interaction (critical for mobile devices)
                try {
                    const audioInitialized = await AudioSystem.init();
                    if (audioInitialized) {
                        console.log('‚úÖ Web Audio API Â∑≤Âú®ÊôÇÈñìË®≠ÂÆöÊôÇÂàùÂßãÂåñ');
                       
                        // Start preloading audio files if not already done
                        const audioFiles = [
                            './voice/S1.mp3',      // ‰∏≠‰∏Ä
                            './voice/S2.mp3',      // ‰∏≠‰∫å
                            './voice/S3.mp3',      // ‰∏≠‰∏â
                            './voice/alarm.mp3',   // Ë≠¶Â†±ËÅ≤
                            './voice/collect.mp3', // Êî∂Âç∑ËÅ≤
                            './voice/15mins.mp3',  // 15ÂàÜÈêò
                            './voice/5mins.mp3',   // 5ÂàÜÈêò
                            './voice/end.mp3'      // ËÄÉË©¶ÁµêÊùü
                        ];
                       
                        // Non-blocking preload
                        AudioSystem.preloadAudioFiles(audioFiles);
                    }
                } catch (error) {
                    console.warn('Èü≥È†ªÂàùÂßãÂåñÂ§±ÊïóÔºå‰ΩÜ‰∏çÂΩ±ÈüøÊôÇÈñìË®≠ÂÆö:', error);
                }
               
                // Update state and display
                AppState.examTimes[this.currentField] = timeString;
               
                // ÂÆâÂÖ®Âú∞Ë®≠ÁΩÆÈö±ËóèinputÁöÑÂÄº
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = timeString;
                }
               
                this.updateDisplay(this.currentField);
               
                // Clear alert histories when time is changed
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
               
                // üéØ ÈáçÂª∫Èü≥ÊïàÊôÇÈñìË°®
                AudioScheduler.rebuildSchedule();
               
                this.close();
               
                // Update main display
                DisplayManager.updateDisplay();
            },
           
            clear() {
                AppState.examTimes[this.currentField] = '';
               
                // ÂÆâÂÖ®Âú∞Ê∏ÖÈô§Èö±ËóèinputÁöÑÂÄº
                const hiddenInput = document.getElementById(this.currentField);
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
               
                this.updateDisplay(this.currentField);
               
                // Clear alert histories
                AppState.alertHistory.clear();
                AppState.timeAlertHistory.clear();
               
                this.close();
               
                // Update main display
                DisplayManager.updateDisplay();
            },
           
            updateDisplay(fieldId) {
                const displayElement = document.getElementById(fieldId + 'Display');
                if (!displayElement) {
                    console.warn(`È°ØÁ§∫ÂÖÉÁ¥†‰∏çÂ≠òÂú®: ${fieldId}Display`);
                    return;
                }
               
                const timeDiv = displayElement.querySelector('.time-display');
                if (!timeDiv) {
                    console.warn(`ÊôÇÈñìÈ°ØÁ§∫ÂÖÉÁ¥†‰∏çÂ≠òÂú®: .time-display in ${fieldId}Display`);
                    return;
                }
               
                const timeValue = AppState.examTimes[fieldId];
               
                if (timeValue) {
                    timeDiv.textContent = timeValue;
                } else {
                    timeDiv.textContent = '--:--';
                }
            },
           
            showValidationMessage(message) {
                // Create custom validation message
                const modal = document.querySelector('.modal-content');
               
                // Remove existing validation message
                const existingMessage = modal.querySelector('.validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
               
                // Create new validation message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'validation-message bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded mb-4';
                messageDiv.textContent = message;
               
                // Insert before time picker
                const timePicker = modal.querySelector('.time-picker');
                modal.insertBefore(messageDiv, timePicker);
               
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 3000);
            },
           
            handleKeyDown(event) {
                if (event.key === 'Escape') {
                    this.close();
                } else if (event.key === 'Enter') {
                    this.save();
                }
            }
        };

        // Utility Functions
        const Utils = {
            formatTime(date) {
                return date.toLocaleTimeString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            formatDate(date) {
                return date.toLocaleDateString('zh-HK', {
                    timeZone: 'Asia/Hong_Kong',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            },

            getHongKongTime() {
                return new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Hong_Kong"}));
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Dark Mode Manager
        const DarkMode = {
            init() {
                // Initial check
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
               
                // Listen for changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
        };

        // Time Calculator
        const TimeCalculator = {
            calculateTimeRemaining(endTime) {
                if (!endTime) return null;
               
                const now = Utils.getHongKongTime();
                const [hours, minutes] = endTime.split(':');
                const examEnd = new Date(now);
                examEnd.setHours(parseInt(hours), parseInt(minutes), 0, 0);
               
                if (examEnd < now) {
                    examEnd.setDate(examEnd.getDate() + 1);
                }
               
                const diff = examEnd - now;
               
                if (diff <= 0) {
                    return { ended: true, text: 'ËÄÉË©¶Â∑≤ÁµêÊùü' };
                }
               
                const totalSeconds = Math.floor(diff / 1000);
                const hours_remaining = Math.floor(totalSeconds / 3600);
                const minutes_remaining = Math.floor((totalSeconds % 3600) / 60);
                const seconds_remaining = totalSeconds % 60;
               
                return {
                    ended: false,
                    totalSeconds,
                    hours: hours_remaining,
                    minutes: minutes_remaining,
                    seconds: seconds_remaining,
                    text: `${hours_remaining.toString().padStart(2, '0')}:${minutes_remaining.toString().padStart(2, '0')}:${seconds_remaining.toString().padStart(2, '0')}`
                };
            }
        };

        // Web Audio API System
        const AudioSystem = {
            audioContext: null,
            audioBuffers: new Map(),
            isInitialized: false,
            audioQueue: [],
            isProcessingQueue: false,

            // ÂàùÂßãÂåñWeb Audio API
            async init() {
                if (this.isInitialized) return true;

                try {
                    // ÂâµÂª∫AudioContext
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                   
                    // Â¶ÇÊûúAudioContextË¢´Êö´ÂÅúÔºåÂòóË©¶ÊÅ¢Âæ©
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                   
                    console.log('Web Audio API ÂàùÂßãÂåñÊàêÂäü');
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('Web Audio API ÂàùÂßãÂåñÂ§±Êïó:', error);
                    return false;
                }
            },

            // ËºâÂÖ•‰∏¶Ëß£Á¢ºÈü≥È†ªÊñá‰ª∂
            async loadAudioFile(url) {
                if (this.audioBuffers.has(url)) {
                    return this.audioBuffers.get(url);
                }

                try {
                    console.log(`ËºâÂÖ•Èü≥È†ªÊñá‰ª∂: ${url}`);
                    const response = await fetch(url);
                   
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                   
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
                   
                    // Á∑©Â≠òËß£Á¢ºÂæåÁöÑÈü≥È†ª
                    this.audioBuffers.set(url, audioBuffer);
                    console.log(`Èü≥È†ªÊñá‰ª∂ËºâÂÖ•ÂÆåÊàê: ${url}`);
                   
                    return audioBuffer;
                } catch (error) {
                    console.error(`ËºâÂÖ•Èü≥È†ªÊñá‰ª∂Â§±Êïó ${url}:`, error);
                    return null;
                }
            },

            // Êí≠ÊîæÂñÆÂÄãÈü≥È†ªÊñá‰ª∂
            async playAudioBuffer(audioBuffer, volume = 1.0) {
                if (!audioBuffer || !this.audioContext) return;

                return new Promise((resolve) => {
                    try {
                        // ÂâµÂª∫Èü≥È†ªÊ∫êÁØÄÈªû
                        const source = this.audioContext.createBufferSource();
                        source.buffer = audioBuffer;
                       
                        // ÂâµÂª∫Â¢ûÁõäÁØÄÈªûÊéßÂà∂Èü≥Èáè
                        const gainNode = this.audioContext.createGain();
                        gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                       
                        // ÈÄ£Êé•ÁØÄÈªûÔºösource -> gainNode -> destination
                        source.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                       
                        // Êí≠ÊîæÁµêÊùüÂõûË™ø
                        source.onended = () => {
                            source.disconnect();
                            gainNode.disconnect();
                            resolve();
                        };
                       
                        // ÈñãÂßãÊí≠Êîæ
                        source.start(0);
                       
                    } catch (error) {
                        console.error('Êí≠ÊîæÈü≥È†ªÂ§±Êïó:', error);
                        resolve();
                    }
                });
            },

            // Êí≠ÊîæÈü≥È†ªÊñá‰ª∂ÔºàÂ∏∂ËºâÂÖ•Ôºâ
            async playAudioFile(src, volume = 1.0) {
                try {
                    // Á¢∫‰øùWeb Audio APIÂ∑≤ÂàùÂßãÂåñ
                    if (!await this.init()) {
                        console.warn('Web Audio API ‰∏çÂèØÁî®ÔºåË∑≥ÈÅéÈü≥È†ªÊí≠Êîæ');
                        return;
                    }

                    // ËºâÂÖ•Èü≥È†ªÊñá‰ª∂
                    const audioBuffer = await this.loadAudioFile(src);
                    if (!audioBuffer) {
                        console.warn(`Ë∑≥ÈÅéÁÑ°ÊïàÈü≥È†ªÊñá‰ª∂: ${src}`);
                        return;
                    }

                    // Êí≠ÊîæÈü≥È†ª
                    await this.playAudioBuffer(audioBuffer, volume);
                    console.log(`Êí≠ÊîæÂÆåÊàê: ${src}`);
                   
                } catch (error) {
                    console.error(`Êí≠ÊîæÈü≥È†ªÊñá‰ª∂Â§±Êïó ${src}:`, error);
                }
            },

            // È†êËºâÂÖ•Èü≥È†ªÊñá‰ª∂
            async preloadAudioFiles(urls) {
                if (!await this.init()) return;

                const loadPromises = urls.map(url => this.loadAudioFile(url));
                const results = await Promise.allSettled(loadPromises);
               
                const successCount = results.filter(result => result.status === 'fulfilled' && result.value).length;
                console.log(`È†êËºâÂÖ•ÂÆåÊàê: ${successCount}/${urls.length} ÂÄãÈü≥È†ªÊñá‰ª∂`);
            },

            // üéØ Èü≥ÊïàÈöäÂàóÁÆ°ÁêÜÁ≥ªÁµ±
            // Ê∑ªÂä†Èü≥ÊïàÂà∞ÈöäÂàóÔºàÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫èÔºåÊîØÊåÅÂÑ™ÂÖàÁ¥öÊê∂Âç†Ôºâ
            enqueueAudio(audioData) {
                // ÂÆöÁæ©ÂÑ™ÂÖàÁ¥öÔºöËÄÉË©¶ÁµêÊùü(1) > 5ÂàÜÈêò(2) > 15ÂàÜÈêò(3) > ÂÖ∂‰ªñ(4)
                const getPriority = (minutes, isAlert = false) => {
                    if (isAlert) return 4; // ÂÖ∂‰ªñÊèêÈÜíÊúÄ‰ΩéÂÑ™ÂÖàÁ¥ö
                    if (minutes === 0) return 1; // ËÄÉË©¶ÁµêÊùüÊúÄÈ´òÂÑ™ÂÖàÁ¥ö
                    if (minutes === 5) return 2; // 5ÂàÜÈêòÁ¨¨‰∫åÂÑ™ÂÖàÁ¥ö
                    if (minutes === 15) return 3; // 15ÂàÜÈêòÁ¨¨‰∏âÂÑ™ÂÖàÁ¥ö
                    return 4; // ÂÖ∂‰ªñ
                };
               
                audioData.priority = getPriority(audioData.minutes, audioData.isAlert);
               
                // üéØ Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂÑ™ÂÖàÁ¥öÊê∂Âç†
                const shouldPreempt = this.isProcessingQueue &&
                                    this.audioQueue.length === 0 &&
                                    audioData.priority < 3; // Âè™ÊúâÈ´òÂÑ™ÂÖàÁ¥öÔºà1, 2ÔºâÊâçËÉΩÊê∂Âç†
               
                if (shouldPreempt) {
                    console.log(`üö® È´òÂÑ™ÂÖàÁ¥öÈü≥ÊïàÊê∂Âç†: ${audioData.description} (ÂÑ™ÂÖàÁ¥ö ${audioData.priority})`);
                    // Â∞áÁï∂ÂâçÈü≥ÊïàÊ®ôË®òÁÇ∫ÈúÄË¶ÅÁ´ãÂç≥Êí≠Êîæ
                    audioData.preempt = true;
                    this.audioQueue.unshift(audioData); // ÊèíÂÖ•Âà∞ÈöäÂàóÊúÄÂâçÈù¢
                    return; // ‰∏çÈáçÊñ∞ÂïüÂãïÈöäÂàóËôïÁêÜÔºåÁï∂ÂâçÊí≠ÊîæÂÆåÊàêÂæåËá™ÂãïËôïÁêÜ
                }
               
                // ÊèíÂÖ•Âà∞ÈöäÂàó‰∏≠Ôºå‰øùÊåÅÂÑ™ÂÖàÁ¥öÊéíÂ∫è
                let inserted = false;
                for (let i = 0; i < this.audioQueue.length; i++) {
                    if (audioData.priority < this.audioQueue[i].priority) {
                        this.audioQueue.splice(i, 0, audioData);
                        inserted = true;
                        break;
                    }
                }
               
                if (!inserted) {
                    this.audioQueue.push(audioData);
                }
               
                console.log(`üìù Èü≥ÊïàÂä†ÂÖ•ÈöäÂàó (ÂÑ™ÂÖàÁ¥ö ${audioData.priority}): ${audioData.description}`);
                console.log(`üìã Áï∂ÂâçÈöäÂàóÈï∑Â∫¶: ${this.audioQueue.length}`);
               
                // Â¶ÇÊûúÁï∂ÂâçÊ≤íÊúâÊí≠ÊîæÔºåÁ´ãÂç≥ÈñãÂßãËôïÁêÜÈöäÂàó
                if (!this.isProcessingQueue) {
                    this.processAudioQueue();
                }
            },
           
            // ËôïÁêÜÈü≥ÊïàÈöäÂàó
            async processAudioQueue() {
                if (this.isProcessingQueue || this.audioQueue.length === 0) {
                    return;
                }
               
                this.isProcessingQueue = true;
                console.log(`üéµ ÈñãÂßãËôïÁêÜÈü≥ÊïàÈöäÂàóÔºåÂÖ± ${this.audioQueue.length} ÂÄãÈ†ÖÁõÆ`);
               
                while (this.audioQueue.length > 0) {
                    const audioData = this.audioQueue.shift();
                    console.log(`üîä Êí≠ÊîæÈü≥Êïà (ÂÑ™ÂÖàÁ¥ö ${audioData.priority}): ${audioData.description}`);
                   
                    try {
                        if (audioData.type === 'timeAlert') {
                            await this.playTimeAlertSequenceInternal(audioData.forms, audioData.minutes);
                        } else if (audioData.type === 'alert') {
                            await this.playAudioSequenceInternal(audioData.message);
                        } else if (audioData.type === 'combinedPreparation') {
                            await this.playCombinedPreparationSequence(audioData.audioFiles);
                        }
                       
                        // üéØ Èü≥ÊïàÁµÑÈñìÊîπÁÇ∫Âç≥ÊôÇÊí≠ÊîæÔºàÁßªÈô§ÈñìÈöîÔºâ
                        // ÁÑ°ÈñìÈöîÔºåÁ´ãÂç≥Êí≠Êîæ‰∏ã‰∏ÄÂÄãÈü≥ÊïàÁµÑ
                       
                    } catch (error) {
                        console.error(`‚ùå Êí≠ÊîæÈü≥ÊïàÂ§±Êïó: ${audioData.description}`, error);
                    }
                }
               
                this.isProcessingQueue = false;
                console.log('‚úÖ Èü≥ÊïàÈöäÂàóËôïÁêÜÂÆåÊàê');
            },

            // Êí≠ÊîæËÄÉË©¶ÊèêÈÜíÈü≥È†ªÂ∫èÂàóÔºàÂÖßÈÉ®ÊñπÊ≥ïÔºâ
            async playAudioSequenceInternal(message) {
                // Á¢∫‰øùWeb Audio APIÂ∑≤ÂàùÂßãÂåñ
                if (!await this.init()) {
                    console.warn('Web Audio API ‰∏çÂèØÁî®ÔºåË∑≥ÈÅéÈü≥È†ªÊí≠Êîæ');
                    return;
                }

                const forms = [];
                if (message.includes('‰∏≠‰∏Ä')) forms.push('‰∏≠‰∏Ä');
                if (message.includes('‰∏≠‰∫å')) forms.push('‰∏≠‰∫å');
                if (message.includes('‰∏≠‰∏â')) forms.push('‰∏≠‰∏â');
               
                const audioFiles = [];
                const formOrder = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
               
                formOrder.forEach((form, index) => {
                    if (forms.includes(form)) {
                        audioFiles.push(`./voice/S${index + 1}.mp3`);
                    }
                });
                audioFiles.push('./voice/alarm.mp3');
               
                console.log(`Êí≠ÊîæËÄÉË©¶ÊèêÈÜíÈü≥È†ªÂ∫èÂàó:`, audioFiles);
               
                // Êí≠ÊîæÂÖ©Ëº™
                for (let round = 0; round < 2; round++) {
                    for (const audioFile of audioFiles) {
                        await this.playAudioFile(audioFile, 0.8);
                    }
                    // ÂÖ©Ëº™‰πãÈñìÁöÑÈñìÈöî
                    if (round === 0) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            },

            // Êí≠ÊîæÊôÇÈñìÊèêÈÜíÈü≥È†ªÂ∫èÂàóÔºàÂÖßÈÉ®ÊñπÊ≥ïÔºâ
            async playTimeAlertSequenceInternal(forms, minutes) {
                // Á¢∫‰øùWeb Audio APIÂ∑≤ÂàùÂßãÂåñ
                if (!await this.init()) {
                    console.warn('Web Audio API ‰∏çÂèØÁî®ÔºåË∑≥ÈÅéÈü≥È†ªÊí≠Êîæ');
                    return;
                }

                const audioFiles = [];
                const formOrder = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
               
                formOrder.forEach((form, index) => {
                    if (forms.includes(form)) {
                        audioFiles.push(`./voice/S${index + 1}.mp3`);
                    }
                });
               
                if (minutes === 0) {
                    audioFiles.push('./voice/end.mp3');
                } else {
                    audioFiles.push(`./voice/${minutes}mins.mp3`);
                }
               
                console.log(`Êí≠ÊîæÊôÇÈñìÊèêÈÜíË™ûÈü≥: ${forms.join(' ')} ${minutes === 0 ? 'ËÄÉË©¶ÁµêÊùü' : minutes + 'ÂàÜÈêò'}`, audioFiles);
               
                // Êí≠ÊîæÂÖ©Ëº™
                for (let round = 0; round < 2; round++) {
                    for (const audioFile of audioFiles) {
                        await this.playAudioFile(audioFile, 0.9);
                    }
                    // ÂÖ©Ëº™‰πãÈñìÁöÑÈñìÈöî
                    if (round === 0) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            },

            // Êí≠ÊîæËÄÉË©¶ÊèêÈÜíÈü≥È†ªÂ∫èÂàóÔºàÂ§ñÈÉ®Êé•Âè£Ôºâ
            async playAudioSequence(message) {
                this.enqueueAudio({
                    type: 'alert',
                    message: message,
                    description: `ËÄÉË©¶ÊèêÈÜí: ${message}`,
                    isAlert: true
                });
            },

            // Êí≠ÊîæÂêà‰ΩµÊ∫ñÂÇôÂ†±ÊôÇÈü≥ÊïàÂ∫èÂàóÔºàÂÖßÈÉ®ÊñπÊ≥ïÔºâ
            async playCombinedPreparationSequence(audioFiles) {
                // Á¢∫‰øùWeb Audio APIÂ∑≤ÂàùÂßãÂåñ
                if (!await this.init()) {
                    console.warn('Web Audio API ‰∏çÂèØÁî®ÔºåË∑≥ÈÅéÈü≥È†ªÊí≠Êîæ');
                    return;
                }

                console.log(`üéØ Êí≠ÊîæÂêà‰ΩµÊ∫ñÂÇôÂ†±ÊôÇÈü≥ÊïàÂ∫èÂàó:`, audioFiles);
               
                // Êí≠ÊîæÂÖ©Ëº™
                for (let round = 0; round < 2; round++) {
                    for (const audioFile of audioFiles) {
                        await this.playAudioFile(audioFile, 0.8);
                    }
                    // ÂÖ©Ëº™‰πãÈñìÁöÑÈñìÈöî
                    if (round === 0) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            },

            // Êí≠ÊîæÊôÇÈñìÊèêÈÜíÈü≥È†ªÂ∫èÂàóÔºàÂ§ñÈÉ®Êé•Âè£Ôºâ
            async playTimeAlertSequence(forms, minutes) {
                this.enqueueAudio({
                    type: 'timeAlert',
                    forms: forms,
                    minutes: minutes,
                    description: `ÊôÇÈñìÊèêÈÜí: ${forms.join(' ')} ${minutes === 0 ? 'ËÄÉË©¶ÁµêÊùü' : minutes + 'ÂàÜÈêò'}`
                });
            },

            // ÂÅúÊ≠¢ÊâÄÊúâÈü≥È†ªÊí≠Êîæ
            stopAll() {
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    try {
                        // Êö´ÂÅúAudioContext‰æÜÂÅúÊ≠¢ÊâÄÊúâÊí≠Êîæ
                        this.audioContext.suspend();
                        AppState.isPlayingAudio = false;
                        console.log('Â∑≤ÂÅúÊ≠¢ÊâÄÊúâÈü≥È†ªÊí≠Êîæ');
                    } catch (error) {
                        console.error('ÂÅúÊ≠¢Èü≥È†ªÊí≠ÊîæÂ§±Êïó:', error);
                    }
                }
            },

            // Ê∏ÖÁêÜË≥áÊ∫ê
            cleanup() {
                this.stopAll();
                this.audioBuffers.clear();
               
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    this.audioContext.close();
                }
               
                this.audioContext = null;
                this.isInitialized = false;
                console.log('Web Audio API Ë≥áÊ∫êÂ∑≤Ê∏ÖÁêÜ');
            }
        };

        // Alert Manager
        const AlertManager = {
            pendingAlerts: [],
            alertBatchTimer: null,
           
            addAlert(message, type = 'info', relatedForms = []) {
                // üéØ Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ê∫ñÂÇôÂ†±ÊôÇÊèêÈÜí
                const isPreparationAlert = message.includes('Â∞öÈ§ò') || message.includes('È†êÂÇôÊî∂Âç∑');
               
                if (isPreparationAlert) {
                    // Â∞áÊ∫ñÂÇôÂ†±ÊôÇÂä†ÂÖ•ÂæÖËôïÁêÜÂàóË°®
                    this.pendingAlerts.push({
                        message,
                        type,
                        relatedForms,
                        timestamp: Date.now()
                    });
                   
                    console.log(`üìù Êî∂ÈõÜÊ∫ñÂÇôÂ†±ÊôÇÊèêÈÜí: ${message}`);
                   
                    // Ë®≠ÁΩÆÊâπÊ¨°ËôïÁêÜË®àÊôÇÂô®Ôºà500msÂæåËôïÁêÜÔºâ
                    if (this.alertBatchTimer) {
                        clearTimeout(this.alertBatchTimer);
                    }
                   
                    this.alertBatchTimer = setTimeout(() => {
                        this.processPendingAlerts();
                    }, 500);
                   
                } else {
                    // ÈùûÊ∫ñÂÇôÂ†±ÊôÇÊèêÈÜíÁõ¥Êé•ËôïÁêÜ
                    this.createAlertElement(message, type, relatedForms);
                    AudioSystem.playAudioSequence(message);
                }
            },
           
            processPendingAlerts() {
                if (this.pendingAlerts.length === 0) return;
               
                console.log(`üéØ ËôïÁêÜ ${this.pendingAlerts.length} ÂÄãÊ∫ñÂÇôÂ†±ÊôÇÊèêÈÜí`);
               
                // üéØ Êñ∞ÈÇèËºØÔºöÂ∞áÊâÄÊúâÂêåÊôÇËß∏ÁôºÁöÑÊ∫ñÂÇôÂ†±ÊôÇÂêà‰ΩµÊàê‰∏ÄÂÄãÁµ±‰∏ÄÁöÑÈü≥ÊïàÁµÑ
                const allForms = new Set();
                const allSessions = new Set();
                const allRelatedForms = [];
                let mostUrgentType = 'info';
                const alertTypes = [];
               
                // Êî∂ÈõÜÊâÄÊúâÂπ¥Á¥öÂíåÁØÄÊ¨°‰ø°ÊÅØ
                this.pendingAlerts.forEach(alert => {
                    // Ëß£ÊûêÂπ¥Á¥ö‰ø°ÊÅØ
                    if (alert.message.includes('‰∏≠‰∏Ä')) allForms.add('‰∏≠‰∏Ä');
                    if (alert.message.includes('‰∏≠‰∫å')) allForms.add('‰∏≠‰∫å');
                    if (alert.message.includes('‰∏≠‰∏â')) allForms.add('‰∏≠‰∏â');
                   
                    // Ëß£ÊûêÁØÄÊ¨°‰ø°ÊÅØ
                    if (alert.message.includes('Á¨¨‰∏ÄÁØÄ')) allSessions.add('Á¨¨‰∏ÄÁØÄ');
                    if (alert.message.includes('Á¨¨‰∫åÁØÄ')) allSessions.add('Á¨¨‰∫åÁØÄ');
                   
                    // Ëß£ÊûêÊèêÈÜíÈ°ûÂûã
                    if (alert.message.includes('È†êÂÇôÊî∂Âç∑')) {
                        alertTypes.push('È†êÂÇôÊî∂Âç∑');
                        mostUrgentType = 'urgent';
                    } else if (alert.message.includes('Â∞öÈ§ò 5ÂàÜÈêò')) {
                        alertTypes.push('Â∞öÈ§ò 5ÂàÜÈêò');
                        if (mostUrgentType !== 'urgent') mostUrgentType = 'warning';
                    } else if (alert.message.includes('Â∞öÈ§ò 15ÂàÜÈêò')) {
                        alertTypes.push('Â∞öÈ§ò 15ÂàÜÈêò');
                        if (mostUrgentType !== 'urgent' && mostUrgentType !== 'warning') mostUrgentType = 'warning';
                    }
                   
                    // Âêà‰ΩµÁõ∏ÈóúÂπ¥Á¥ö‰ø°ÊÅØ
                    allRelatedForms.push(...alert.relatedForms);
                });
               
                // ËΩâÊèõÁÇ∫ÊéíÂ∫èÁöÑÊï∏ÁµÑ
                const formsArray = Array.from(allForms).sort((a, b) => {
                    const order = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
                    return order.indexOf(a) - order.indexOf(b);
                });
                const sessionsArray = Array.from(allSessions);
               
                console.log(`üéØ Ê∂âÂèäÂπ¥Á¥ö: ${formsArray.join(', ')}`);
                console.log(`üéØ Ê∂âÂèäÁØÄÊ¨°: ${sessionsArray.join(', ')}`);
                console.log(`üéØ ÊèêÈÜíÈ°ûÂûã: ${[...new Set(alertTypes)].join(', ')}`);
               
                // üéµ Âè™Âêà‰ΩµÈü≥ÊïàÊí≠ÊîæÔºåÊñáÂ≠óÊèêÁ§∫‰øùÊåÅÂàÜÈñãÈ°ØÁ§∫
                // ÊåâÂéüÂÖàÁöÑÈÇèËºØÂàÜÂà•ÂâµÂª∫ÂêÑÂÄãÊèêÈÜíÂÖÉÁ¥†
                const groupedAlerts = {};
                this.pendingAlerts.forEach(alert => {
                    // Ëß£ÊûêÂπ¥Á¥ö‰ø°ÊÅØ
                    const forms = [];
                    if (alert.message.includes('‰∏≠‰∏Ä')) forms.push('‰∏≠‰∏Ä');
                    if (alert.message.includes('‰∏≠‰∫å')) forms.push('‰∏≠‰∫å');
                    if (alert.message.includes('‰∏≠‰∏â')) forms.push('‰∏≠‰∏â');
                   
                    // Ëß£ÊûêÊèêÈÜíÈ°ûÂûã
                    let alertKey = '';
                    if (alert.message.includes('È†êÂÇôÊî∂Âç∑')) {
                        alertKey = 'È†êÂÇôÊî∂Âç∑';
                    } else if (alert.message.includes('Â∞öÈ§ò 5ÂàÜÈêò')) {
                        alertKey = 'Â∞öÈ§ò 5ÂàÜÈêò';
                    } else if (alert.message.includes('Â∞öÈ§ò 15ÂàÜÈêò')) {
                        alertKey = 'Â∞öÈ§ò 15ÂàÜÈêò';
                    }
                   
                    if (!groupedAlerts[alertKey]) {
                        groupedAlerts[alertKey] = {
                            forms: new Set(),
                            sessions: new Set(),
                            relatedForms: [],
                            type: alert.type
                        };
                    }
                   
                    forms.forEach(form => groupedAlerts[alertKey].forms.add(form));
                   
                    // Ëß£ÊûêÁØÄÊ¨°
                    if (alert.message.includes('Á¨¨‰∏ÄÁØÄ')) groupedAlerts[alertKey].sessions.add('Á¨¨‰∏ÄÁØÄ');
                    if (alert.message.includes('Á¨¨‰∫åÁØÄ')) groupedAlerts[alertKey].sessions.add('Á¨¨‰∫åÁØÄ');
                   
                    // Âêà‰ΩµÁõ∏ÈóúÂπ¥Á¥ö‰ø°ÊÅØ
                    groupedAlerts[alertKey].relatedForms.push(...alert.relatedForms);
                });
               
                // üéØ ÂàÜÂà•ÂâµÂª∫ÊñáÂ≠óÊèêÈÜíÔºàÂéüÂÖàÈÇèËºØÔºâ
                Object.entries(groupedAlerts).forEach(([alertKey, data]) => {
                    const formsArray = Array.from(data.forms).sort();
                    const sessionsArray = Array.from(data.sessions);
                   
                    let separateMessage = '';
                    if (formsArray.length === 3) {
                        // ÂÖ®ÈÉ®Âπ¥Á¥ö
                        separateMessage = `ÂÖ®ÈÉ®Âπ¥Á¥ö ${sessionsArray.join(' ')} ${alertKey}`;
                    } else {
                        separateMessage = `${formsArray.join(' ')} ${sessionsArray.join(' ')} ${alertKey}`;
                    }
                   
                    console.log(`üìù ÂâµÂª∫ÂàÜÂà•ÁöÑÊñáÂ≠óÊèêÈÜí: ${separateMessage}`);
                   
                    // ÂâµÂª∫ÂàÜÂà•ÁöÑÊèêÈÜíÂÖÉÁ¥†
                    this.createAlertElement(separateMessage, data.type, data.relatedForms);
                });
               
                // üéµ Êí≠ÊîæÁµ±‰∏ÄÁöÑÂêà‰ΩµÈü≥ÊïàÁµÑÔºàÊåâÂπ¥Á¥öÈ†ÜÂ∫èÔºö‰∏≠‰∏Ä > ‰∏≠‰∫å > ‰∏≠‰∏â > Ë≠¶Â†±Ôºâ
                const uniqueAlertTypes = [...new Set(alertTypes)];
                this.playCombinedPreparationAudio(formsArray, uniqueAlertTypes.join('„ÄÅ'));
               
                // Ê∏ÖÁ©∫ÂæÖËôïÁêÜÂàóË°®
                this.pendingAlerts = [];
                this.alertBatchTimer = null;
            },
           
            playCombinedPreparationAudio(forms, alertType) {
                // üéØ ÂàÜÂà•ËôïÁêÜÂ†±ÊôÇÂíåÊî∂Âç∑ÂÖ©Á®ÆÈü≥ÊïàÈ°ûÂûã
                const formOrder = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
               
                // Ëß£ÊûêÊèêÈÜíÈ°ûÂûãÔºåÂàÜÈñãËôïÁêÜÂ†±ÊôÇÂíåÊî∂Âç∑
                const alertTypes = alertType.split('„ÄÅ').map(type => type.trim());
                const hasCollectAlert = alertTypes.some(type => type.includes('È†êÂÇôÊî∂Âç∑'));
                const hasTimeAlert = alertTypes.some(type => type.includes('Â∞öÈ§ò'));
               
                console.log(`üéØ ÂàÜÊûêÈü≥ÊïàÈ°ûÂûã: ${alertType}`);
                console.log(`üìã ÂåÖÂê´Êî∂Âç∑ÊèêÈÜí: ${hasCollectAlert}, ÂåÖÂê´Â†±ÊôÇÊèêÈÜí: ${hasTimeAlert}`);
               
                // üéØ ÂàÜÊûêÂì™‰∫õÂπ¥Á¥öÈúÄË¶ÅÊî∂Âç∑ÊèêÈÜíÔºåÂì™‰∫õÈúÄË¶ÅÂ†±ÊôÇÊèêÈÜí
                const collectForms = new Set();  // ÈúÄË¶ÅÊî∂Âç∑Èü≥ÊïàÁöÑÂπ¥Á¥ö
                const timeForms = new Set();     // ÈúÄË¶ÅÂ†±ÊôÇÈü≥ÊïàÁöÑÂπ¥Á¥ö
               
                // ÂæûÂéüÂßãÂæÖËôïÁêÜÊèêÈÜí‰∏≠ÂàÜÊûêÊØèÂÄãÂπ¥Á¥öÁöÑÂØ¶ÈöõÈúÄÊ±Ç
                this.pendingAlerts.forEach(alert => {
                    const alertForms = [];
                    if (alert.message.includes('‰∏≠‰∏Ä')) alertForms.push('‰∏≠‰∏Ä');
                    if (alert.message.includes('‰∏≠‰∫å')) alertForms.push('‰∏≠‰∫å');
                    if (alert.message.includes('‰∏≠‰∏â')) alertForms.push('‰∏≠‰∏â');
                   
                    if (alert.message.includes('È†êÂÇôÊî∂Âç∑')) {
                        // ÈÄô‰∫õÂπ¥Á¥öÈúÄË¶ÅÊî∂Âç∑Èü≥Êïà
                        alertForms.forEach(form => collectForms.add(form));
                    } else if (alert.message.includes('Â∞öÈ§ò')) {
                        // ÈÄô‰∫õÂπ¥Á¥öÈúÄË¶ÅÂ†±ÊôÇÈü≥Êïà
                        alertForms.forEach(form => timeForms.add(form));
                    }
                });
               
                const collectFormsArray = Array.from(collectForms).sort((a, b) => {
                    const order = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
                    return order.indexOf(a) - order.indexOf(b);
                });
                const timeFormsArray = Array.from(timeForms).sort((a, b) => {
                    const order = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
                    return order.indexOf(a) - order.indexOf(b);
                });
               
                console.log(`üì¶ ÈúÄË¶ÅÊî∂Âç∑Èü≥ÊïàÁöÑÂπ¥Á¥ö: ${collectFormsArray.join(' ')}`);
                console.log(`üîî ÈúÄË¶ÅÂ†±ÊôÇÈü≥ÊïàÁöÑÂπ¥Á¥ö: ${timeFormsArray.join(' ')}`);
               
                // üì¶ ÂÑ™ÂÖàËôïÁêÜÊî∂Âç∑ÊèêÈÜíÔºà30Áßí/È†êÂÇôÊî∂Âç∑Ôºâ- ÊúÄÈ´òÂÑ™ÂÖàÁ¥ö
                if (collectFormsArray.length > 0) {
                    const collectAlertAudioFiles = [];
                   
                    // ÊåâÂπ¥Á¥öÈ†ÜÂ∫èÊ∑ªÂä†Èü≥ÊïàÊñá‰ª∂
                    formOrder.forEach((form, index) => {
                        if (collectFormsArray.includes(form)) {
                            collectAlertAudioFiles.push(`./voice/S${index + 1}.mp3`);
                        }
                    });
                   
                    // Ê∑ªÂä†Êî∂Âç∑Èü≥Êïà
                    collectAlertAudioFiles.push('./voice/collect.mp3');
                   
                    console.log(`üì¶ Êí≠ÊîæÊî∂Âç∑Èü≥Êïà (ÂÑ™ÂÖà): ${collectFormsArray.join(' ')} È†êÂÇôÊî∂Âç∑`, collectAlertAudioFiles);
                   
                    AudioSystem.enqueueAudio({
                        type: 'combinedPreparation',
                        audioFiles: collectAlertAudioFiles,
                        description: `Âêà‰ΩµÊî∂Âç∑ÊèêÈÜí: ${collectFormsArray.join(' ')} È†êÂÇôÊî∂Âç∑`,
                        isAlert: true,
                        priority: 2 // Êî∂Âç∑ÊèêÈÜíÊúÄÈ´òÂÑ™ÂÖàÁ¥öÔºàÊ∑∑ÂêàÊÉÖÊ≥Å‰∏ãÂÖàÊí≠ÊîæÔºâ
                    });
                }
               
                // üîî ÂÜçËôïÁêÜÂ†±ÊôÇÊèêÈÜíÔºà15ÂàÜÈêò„ÄÅ5ÂàÜÈêòÔºâ- ËºÉ‰ΩéÂÑ™ÂÖàÁ¥ö
                if (timeFormsArray.length > 0) {
                    const timeAlertAudioFiles = [];
                   
                    // ÊåâÂπ¥Á¥öÈ†ÜÂ∫èÊ∑ªÂä†Èü≥ÊïàÊñá‰ª∂
                    formOrder.forEach((form, index) => {
                        if (timeFormsArray.includes(form)) {
                            timeAlertAudioFiles.push(`./voice/S${index + 1}.mp3`);
                        }
                    });
                   
                    // Ê∑ªÂä†Â†±ÊôÇË≠¶Â†±ËÅ≤
                    timeAlertAudioFiles.push('./voice/alarm.mp3');
                   
                    console.log(`üîî Êí≠ÊîæÂ†±ÊôÇÈü≥Êïà (ÂæåÁ∫å): ${timeFormsArray.join(' ')} Â†±ÊôÇÊèêÈÜí`, timeAlertAudioFiles);
                   
                    AudioSystem.enqueueAudio({
                        type: 'combinedPreparation',
                        audioFiles: timeAlertAudioFiles,
                        description: `Âêà‰ΩµÂ†±ÊôÇÊèêÈÜí: ${timeFormsArray.join(' ')} Â†±ÊôÇ`,
                        isAlert: true,
                        priority: 4 // Â†±ÊôÇÊèêÈÜíËºÉ‰ΩéÂÑ™ÂÖàÁ¥öÔºàÊ∑∑ÂêàÊÉÖÊ≥Å‰∏ãÂæåÊí≠ÊîæÔºâ
                    });
                }
               
                // üéµ Â¶ÇÊûúÊ≤íÊúâÊòéÁ¢∫ÁöÑÈ°ûÂûãÔºå‰ΩøÁî®È†êË®≠Â†±ÊôÇÈü≥Êïà
                if (!hasTimeAlert && !hasCollectAlert) {
                    const defaultAudioFiles = [];
                   
                    formOrder.forEach((form, index) => {
                        if (forms.includes(form)) {
                            defaultAudioFiles.push(`./voice/S${index + 1}.mp3`);
                        }
                    });
                   
                    defaultAudioFiles.push('./voice/alarm.mp3');
                   
                    console.log(`üéµ Êí≠ÊîæÈ†êË®≠Èü≥Êïà: ${forms.join(' ')} ${alertType}`, defaultAudioFiles);
                   
                    AudioSystem.enqueueAudio({
                        type: 'combinedPreparation',
                        audioFiles: defaultAudioFiles,
                        description: `Âêà‰ΩµÊèêÈÜí: ${forms.join(' ')} ${alertType}`,
                        isAlert: true,
                        priority: 4
                    });
                }
            },
           
            createAlertElement(message, type = 'info', relatedForms = []) {
                const alertsList = document.getElementById('alertsList');
                const placeholder = alertsList.querySelector('div');
                if (placeholder && placeholder.textContent.includes('Êö´ÁÑ°ÊèêÈÜí')) {
                    placeholder.remove();
                }
               
                const alertDiv = document.createElement('div');
                const alertClass = type === 'urgent' ?
                    'urgent-flash border-accent text-yellow-900 dark:text-yellow-100' :
                    type === 'warning' ?
                    'warning-flash border-warning text-yellow-900 dark:text-yellow-100' :
                    'bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 text-slate-800 dark:text-slate-200';
               
                alertDiv.className = `p-4 border-2 ${alertClass} transition-all rounded`;
                alertDiv.setAttribute('role', 'alert');
                alertDiv.setAttribute('aria-live', 'assertive');
               
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-lg">${message}</div>
                            <div class="text-sm opacity-75 mt-1">${Utils.formatTime(Utils.getHongKongTime())}</div>
                        </div>
                        <button onclick="AlertManager.removeAlert(this)" class="text-xl opacity-70 hover:opacity-100 font-bold ml-4 hover:bg-white hover:bg-opacity-20 w-8 h-8 flex items-center justify-center transition-all rounded" aria-label="ÈóúÈñâÊèêÈÜí">√ó</button>
                    </div>
                `;
               
                alertDiv.dataset.relatedForms = JSON.stringify(relatedForms);
                alertsList.insertBefore(alertDiv, alertsList.firstChild);
               
                let countdown = 60;
                const countdownTimer = setInterval(() => {
                    countdown--;
                   
                    const messageElement = alertDiv.querySelector('.font-bold');
                    if (messageElement) {
                        if (countdown <= 10 && countdown > 0) {
                            messageElement.innerHTML = `${message} <span class="countdown-timer text-xs opacity-60 ml-2">(${countdown}s)</span>`;
                        } else if (countdown > 10) {
                            messageElement.innerHTML = message;
                        }
                    }
                   
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        this.removeAlert(alertDiv.querySelector('button'), true);
                    }
                }, 1000);
               
                alertDiv.dataset.timerId = countdownTimer;
                AppState.timers.set(alertDiv, countdownTimer);
            },

            removeAlert(buttonOrElement, isAutoRemove = false) {
                let alertDiv;
                if (buttonOrElement.tagName === 'BUTTON') {
                    alertDiv = buttonOrElement.parentElement.parentElement;
                } else {
                    alertDiv = buttonOrElement;
                }
               
                if (alertDiv.dataset.timerId) {
                    clearInterval(parseInt(alertDiv.dataset.timerId));
                    AppState.timers.delete(alertDiv);
                }
               
                if (isAutoRemove && alertDiv.dataset.relatedForms) {
                    try {
                        const relatedForms = JSON.parse(alertDiv.dataset.relatedForms);
                        relatedForms.forEach(formInfo => {
                            const container = document.getElementById(`${formInfo.form}${formInfo.session}`);
                            if (container) {
                                const endTime = AppState.examTimes[formInfo.form + formInfo.sessionIndex + 1];
                                const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                               
                                if (timeRemaining && !timeRemaining.ended) {
                                    let className = 'py-3 px-4 border-2 transition-all border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded';
                                    container.className = className;
                                }
                            }
                        });
                    } catch (e) {
                        console.error('Ëß£ÊûêÁõ∏ÈóúÂπ¥Á¥ö‰ø°ÊÅØÂ§±Êïó:', e);
                    }
                }
               
                alertDiv.remove();
               
                const alertsList = document.getElementById('alertsList');
                if (alertsList.children.length === 0) {
                    alertsList.innerHTML = `
                        <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                            <div class="text-lg font-semibold">Êö´ÁÑ°ÊèêÈÜí</div>
                            <div class="text-sm mt-1">NO ALERTS</div>
                        </div>
                    `;
                }
            }
        };

        // üéØ Êñ∞Â¢ûÔºöÈü≥Ë®äÊôÇÈñìË°®È†êËôïÁêÜÁ≥ªÁµ±
        const AudioScheduler = {
            // È†êËôïÁêÜÈü≥ÊïàÊôÇÈñìË°®
            buildAudioSchedule() {
                AppState.audioSchedule.clear();
               
                if (!this.hasValidExamTimes()) {
                    console.log('üìã Ë∑≥ÈÅéÈü≥ÊïàÊôÇÈñìË°®Âª∫ÊßãÔºöÁÑ°ÊúâÊïàËÄÉË©¶ÊôÇÈñì');
                    AppState.scheduleBuilt = false;
                    return;
                }
               
                const today = Utils.getHongKongTime();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
               
                // ÁÇ∫‰ªäÂ§©ÂíåÊòéÂ§©Âª∫ÊßãÊôÇÈñìË°®
                [today, tomorrow].forEach(date => {
                    this.buildScheduleForDate(date);
                });
               
                AppState.scheduleBuilt = true;
                console.log(`üéØ Èü≥ÊïàÊôÇÈñìË°®Âª∫ÊßãÂÆåÊàêÔºåÂÖ± ${AppState.audioSchedule.size} ÂÄãÊôÇÈñìÈªû`);
                this.logSchedule();
            },
           
            // Ê™¢Êü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑËÄÉË©¶ÊôÇÈñì
            hasValidExamTimes() {
                return Object.values(AppState.examTimes).some(time => time !== '');
            },
           
            // ÁÇ∫ÁâπÂÆöÊó•ÊúüÂª∫ÊßãÊôÇÈñìË°®
            buildScheduleForDate(date) {
                const forms = [
                    { key: 'form1End1', name: '‰∏≠‰∏Ä', session: 'Á¨¨‰∏ÄÁØÄ' },
                    { key: 'form1End2', name: '‰∏≠‰∏Ä', session: 'Á¨¨‰∫åÁØÄ' },
                    { key: 'form2End1', name: '‰∏≠‰∫å', session: 'Á¨¨‰∏ÄÁØÄ' },
                    { key: 'form2End2', name: '‰∏≠‰∫å', session: 'Á¨¨‰∫åÁØÄ' },
                    { key: 'form3End1', name: '‰∏≠‰∏â', session: 'Á¨¨‰∏ÄÁØÄ' },
                    { key: 'form3End2', name: '‰∏≠‰∏â', session: 'Á¨¨‰∫åÁØÄ' }
                ];
               
                // Êî∂ÈõÜÊâÄÊúâÊôÇÈñì‰∫ã‰ª∂
                const timeEvents = [];
               
                forms.forEach(form => {
                    const endTimeStr = AppState.examTimes[form.key];
                    if (!endTimeStr) return;
                   
                    const [hours, minutes] = endTimeStr.split(':');
                    const endTime = new Date(date);
                    endTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                   
                    // ÂêÑÁ®ÆÊèêÈÜíÊôÇÈñìÈªû
                    const alertTimes = [
                        { offset: -15*60*1000, minutes: 15, type: 'warning' }, // 15ÂàÜÈêòÂâç
                        { offset: -5*60*1000, minutes: 5, type: 'warning' },   // 5ÂàÜÈêòÂâç
                        { offset: 0, minutes: 0, type: 'complete' }              // ËÄÉË©¶ÁµêÊùü
                    ];
                   
                    alertTimes.forEach(alert => {
                        const triggerTime = new Date(endTime.getTime() + alert.offset);
                       
                        timeEvents.push({
                            timestamp: triggerTime.getTime(),
                            timeStr: Utils.formatTime(triggerTime),
                            form: form.name,
                            session: form.session,
                            minutes: alert.minutes,
                            type: alert.type,
                            priority: alert.minutes === 0 ? 1 : alert.minutes === 5 ? 2 : 3
                        });
                    });
                });
               
                // ÊåâÊôÇÈñìÊà≥ÊéíÂ∫è
                timeEvents.sort((a, b) => a.timestamp - b.timestamp);
               
                // Âêà‰ΩµÂêåÊôÇËß∏ÁôºÁöÑ‰∫ã‰ª∂
                this.mergeSimultaneousEvents(timeEvents);
            },
           
            // Âêà‰ΩµÂêåÊôÇËß∏ÁôºÁöÑ‰∫ã‰ª∂ÔºàÂÆπÂ∑Æ5ÁßíÔºâ
            mergeSimultaneousEvents(timeEvents) {
                const tolerance = 5000; // 5ÁßíÂÆπÂ∑Æ
                const mergedGroups = [];
                let currentGroup = [];
               
                timeEvents.forEach((event, index) => {
                    if (index === 0) {
                        currentGroup = [event];
                    } else {
                        const timeDiff = Math.abs(event.timestamp - currentGroup[0].timestamp);
                       
                        if (timeDiff <= tolerance) {
                            // Âú®ÂÆπÂ∑ÆÁØÑÂúçÂÖßÔºåÂêà‰ΩµÂà∞Áï∂ÂâçÁµÑ
                            currentGroup.push(event);
                        } else {
                            // Ë∂ÖÂá∫ÂÆπÂ∑ÆÔºåËôïÁêÜÁï∂ÂâçÁµÑ‰∏¶ÈñãÂßãÊñ∞ÁµÑ
                            this.processEventGroup(currentGroup);
                            currentGroup = [event];
                        }
                    }
                });
               
                // ËôïÁêÜÊúÄÂæå‰∏ÄÁµÑ
                if (currentGroup.length > 0) {
                    this.processEventGroup(currentGroup);
                }
            },
           
            // ËôïÁêÜ‰∫ã‰ª∂ÁµÑÔºàÁîüÊàêÈ†êËôïÁêÜÁöÑÈü≥ÊïàÂ∫èÂàóÔºâ
            processEventGroup(eventGroup) {
                if (eventGroup.length === 0) return;
               
                // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫è
                eventGroup.sort((a, b) => a.priority - b.priority);
               
                const baseTimestamp = eventGroup[0].timestamp;
                const roundedTimestamp = Math.floor(baseTimestamp / 1000) * 1000; // ÂõõÊç®‰∫îÂÖ•Âà∞Áßí
               
                // ÁîüÊàêÂÑ™ÂåñÁöÑÈü≥ÊïàÂ∫èÂàó
                const audioSequence = this.generateOptimizedAudioSequence(eventGroup);
               
                AppState.audioSchedule.set(roundedTimestamp, audioSequence);
               
                console.log(`üìÖ ${Utils.formatTime(new Date(roundedTimestamp))} - È†êËôïÁêÜ ${eventGroup.length} ÂÄã‰∫ã‰ª∂`);
            },
           
            // ÁîüÊàêÂÑ™ÂåñÁöÑÈü≥ÊïàÂ∫èÂàó
            generateOptimizedAudioSequence(eventGroup) {
                const sequence = {
                    timestamp: eventGroup[0].timestamp,
                    timeStr: eventGroup[0].timeStr,
                    events: eventGroup,
                    audioItems: []
                };
               
                // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫èÂæåÁîüÊàêÈü≥ÊïàÈ†ÖÁõÆ
                eventGroup.forEach((event, index) => {
                    const audioItem = {
                        priority: event.priority,
                        description: `ÊôÇÈñìÊèêÈÜí: ${event.form} ${event.minutes === 0 ? 'ËÄÉË©¶ÁµêÊùü' : event.minutes + 'ÂàÜÈêò'}`,
                        type: 'timeAlert',
                        forms: [event.form],
                        minutes: event.minutes,
                        delay: index * 100 // ÈåØÈñãÊí≠ÊîæÊôÇÈñì
                    };
                   
                    sequence.audioItems.push(audioItem);
                });
               
                return sequence;
            },
           
            // Ê™¢Êü•‰∏¶Âü∑Ë°åÈ†êÂÆöÁöÑÈü≥Êïà
            checkScheduledAudio() {
                if (!AppState.scheduleBuilt || AppState.audioSchedule.size === 0) {
                    return;
                }
               
                const now = Utils.getHongKongTime();
                const currentTimestamp = Math.floor(now.getTime() / 1000) * 1000;
               
                // Ê™¢Êü•Áï∂ÂâçÊôÇÈñìÈªûÁöÑÈü≥Êïà
                const scheduledSequence = AppState.audioSchedule.get(currentTimestamp);
                if (scheduledSequence) {
                    console.log(`‚è∞ Âü∑Ë°åÈ†êÂÆöÈü≥ÊïàÂ∫èÂàó: ${scheduledSequence.timeStr}`);
                    this.executeScheduledSequence(scheduledSequence);
                   
                    // ÁßªÈô§Â∑≤Âü∑Ë°åÁöÑÊôÇÈñìÈªû
                    AppState.audioSchedule.delete(currentTimestamp);
                }
               
                // Ê∏ÖÁêÜÈÅéÊúüÁöÑÊôÇÈñìÈªûÔºàË∂ÖÈÅé1Â∞èÊôÇÂâçÁöÑÔºâ
                const oneHourAgo = currentTimestamp - 3600000;
                for (const [timestamp] of AppState.audioSchedule) {
                    if (timestamp < oneHourAgo) {
                        AppState.audioSchedule.delete(timestamp);
                    }
                }
            },
           
            // Âü∑Ë°åÈ†êÂÆöÁöÑÈü≥ÊïàÂ∫èÂàó
            executeScheduledSequence(sequence) {
                sequence.audioItems.forEach((audioItem, index) => {
                    setTimeout(() => {
                        // Ê®ôË®òÁÇ∫Â∑≤ËôïÁêÜÔºåÈÅøÂÖçÈáçË§áËß∏Áôº
                        const alertKey = `${audioItem.forms.join('-')}-${audioItem.minutes}mins-${sequence.timestamp}`;
                        AppState.timeAlertHistory.add(alertKey);
                       
                        // Áõ¥Êé•Êí≠ÊîæÈü≥Êïà
                        AudioSystem.playTimeAlertSequence(audioItem.forms, audioItem.minutes);
                        console.log(`üéµ È†êÂÆöÊí≠Êîæ: ${audioItem.description} (ÂÑ™ÂÖàÁ¥ö ${audioItem.priority})`);
                    }, audioItem.delay);
                });
            },
           
            // È°ØÁ§∫Èü≥ÊïàÊôÇÈñìË°®
            logSchedule() {
                if (AppState.audioSchedule.size === 0) {
                    console.log('üìã Èü≥ÊïàÊôÇÈñìË°®ÔºöÁ©∫');
                    return;
                }
               
                console.log('üìã Èü≥ÊïàÊôÇÈñìË°®È†êË¶ΩÔºö');
                const sortedEntries = Array.from(AppState.audioSchedule.entries())
                    .sort(([a], [b]) => a - b)
                    .slice(0, 10); // Âè™È°ØÁ§∫Ââç10ÂÄã
               
                sortedEntries.forEach(([timestamp, sequence]) => {
                    const eventDescriptions = sequence.events.map(e =>
                        `${e.form} ${e.minutes === 0 ? 'ÁµêÊùü' : e.minutes + 'min'}`
                    ).join(', ');
                    console.log(`   ${sequence.timeStr} - ${eventDescriptions}`);
                });
               
                if (AppState.audioSchedule.size > 10) {
                    console.log(`   ... ÈÇÑÊúâ ${AppState.audioSchedule.size - 10} ÂÄãÊôÇÈñìÈªû`);
                }
            },
           
            // ÈáçÂª∫ÊôÇÈñìË°®
            rebuildSchedule() {
                console.log('üîÑ ÈáçÂª∫Èü≥ÊïàÊôÇÈñìË°®...');
                this.buildAudioSchedule();
            }
        };

        // Alert Checker
        const AlertChecker = {
            checkAndProcessAlerts() {
                const forms = ['form1', 'form2', 'form3'];
                const formNames = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
                const sessions = ['Session1', 'Session2'];
                const sessionNames = ['Á¨¨‰∏ÄÁØÄ', 'Á¨¨‰∫åÁØÄ'];
               
                const alertsToProcess = [];
               
                forms.forEach((form, formIndex) => {
                    sessions.forEach((session, sessionIndex) => {
                        const endTime = AppState.examTimes[`${form}End${sessionIndex + 1}`];
                        const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                       
                        if (!timeRemaining || timeRemaining.ended) return;
                       
                        const totalSeconds = timeRemaining.totalSeconds;
                        const alertKey = `${formNames[formIndex]}-${sessionNames[sessionIndex]}`;
                       
                        const alerts = [
                            { seconds: 930, message: '15ÂàÜÈêò', type: 'warning' },
                            { seconds: 330, message: '5ÂàÜÈêò', type: 'warning' },
                            { seconds: 30, message: 'È†êÂÇôÊî∂Âç∑', type: 'urgent' }
                        ];
                       
                        alerts.forEach(alert => {
                            const alertId = `${alertKey}-${alert.seconds}`;
                            if (totalSeconds <= alert.seconds && totalSeconds > alert.seconds - 5 && !AppState.alertHistory.has(alertId)) {
                                alertsToProcess.push({
                                    formName: formNames[formIndex],
                                    sessionName: sessionNames[sessionIndex],
                                    alertSeconds: alert.seconds,
                                    message: alert.message,
                                    type: alert.type,
                                    alertId: alertId
                                });
                                AppState.alertHistory.add(alertId);
                            }
                        });
                    });
                });
               
                const groupedAlerts = {};
                alertsToProcess.forEach(alert => {
                    const groupKey = `${alert.sessionName}-${alert.alertSeconds}`;
                    if (!groupedAlerts[groupKey]) {
                        groupedAlerts[groupKey] = {
                            sessionName: alert.sessionName,
                            message: alert.message,
                            type: alert.type,
                            forms: []
                        };
                    }
                    groupedAlerts[groupKey].forms.push(alert.formName);
                });
               
                Object.values(groupedAlerts).forEach(group => {
                    const formsText = group.forms.join(' ');
                    let alertMessage;
                   
                    if (group.message === 'È†êÂÇôÊî∂Âç∑') {
                        alertMessage = `${formsText} ${group.sessionName} ${group.message}`;
                    } else {
                        alertMessage = `${formsText} ${group.sessionName} Â∞öÈ§ò ${group.message}`;
                    }
                   
                    const relatedForms = [];
                    const forms = ['form1', 'form2', 'form3'];
                    const formNames = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
                    const sessions = ['Session1', 'Session2'];
                    const sessionNames = ['Á¨¨‰∏ÄÁØÄ', 'Á¨¨‰∫åÁØÄ'];
                   
                    group.forms.forEach(formName => {
                        const formIndex = formNames.indexOf(formName);
                        const sessionIndex = sessionNames.indexOf(group.sessionName);
                        if (formIndex !== -1 && sessionIndex !== -1) {
                            relatedForms.push({
                                form: forms[formIndex],
                                session: sessions[sessionIndex],
                                sessionIndex: sessionIndex
                            });
                        }
                    });
                   
                    AlertManager.addAlert(alertMessage, group.type, relatedForms);
                });
            },

            checkTimeAlerts() {
                const forms = ['form1', 'form2', 'form3'];
                const formNames = ['‰∏≠‰∏Ä', '‰∏≠‰∫å', '‰∏≠‰∏â'];
                const sessions = ['Session1', 'Session2'];
                const sessionNames = ['Á¨¨‰∏ÄÁØÄ', 'Á¨¨‰∫åÁØÄ'];
               
                const specificMinutes = [15, 5, 0];
               
                // üéØ Êî∂ÈõÜÊú¨Ê¨°Ê™¢Êü•‰∏≠ÊâÄÊúâËß∏ÁôºÁöÑÊôÇÈñìÊèêÈÜí
                const allTriggeredAlerts = [];
               
                specificMinutes.forEach(targetMinutes => {
                    const formsAtTime = [];
                   
                    forms.forEach((form, formIndex) => {
                        sessions.forEach((session, sessionIndex) => {
                            const endTime = AppState.examTimes[`${form}End${sessionIndex + 1}`];
                            const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                           
                            if (!timeRemaining) return;
                           
                            let shouldTrigger = false;
                           
                            if (targetMinutes === 0) {
                                shouldTrigger = timeRemaining.ended;
                            } else {
                                if (!timeRemaining.ended) {
                                    const totalMinutes = Math.floor(timeRemaining.totalSeconds / 60);
                                    const seconds = timeRemaining.totalSeconds % 60;
                                    shouldTrigger = (totalMinutes === targetMinutes && seconds <= 2);
                                }
                            }
                           
                            if (shouldTrigger) {
                                const formKey = `${formNames[formIndex]}-${sessionNames[sessionIndex]}`;
                                if (!formsAtTime.some(item => item.form === formNames[formIndex])) {
                                    formsAtTime.push({
                                        form: formNames[formIndex],
                                        session: sessionNames[sessionIndex],
                                        key: formKey
                                    });
                                }
                            }
                        });
                    });
                   
                    if (formsAtTime.length > 0) {
                        const timeAlertKey = `${targetMinutes}mins-${formsAtTime.map(f => f.form).sort().join('-')}`;
                       
                        if (!AppState.timeAlertHistory.has(timeAlertKey)) {
                            AppState.timeAlertHistory.add(timeAlertKey);
                            const formsList = formsAtTime.map(f => f.form);
                           
                            // üéØ Ê∑ªÂä†Âà∞Êú¨Ê¨°Ëß∏ÁôºÂàóË°®ÔºåËÄå‰∏çÊòØÁ´ãÂç≥Êí≠Êîæ
                            allTriggeredAlerts.push({
                                forms: formsList,
                                minutes: targetMinutes,
                                priority: targetMinutes === 0 ? 1 : targetMinutes === 5 ? 2 : 3,
                                description: `${formsList.join(' ')} ${targetMinutes === 0 ? 'ËÄÉË©¶ÁµêÊùü' : targetMinutes + 'ÂàÜÈêò'}`
                            });
                           
                            console.log(`üîî Êî∂ÈõÜÊôÇÈñìÊèêÈÜí: ${formsList.join(' ')} ${targetMinutes === 0 ? 'ËÄÉË©¶ÁµêÊùü' : targetMinutes + 'ÂàÜÈêò'} (ÂÑ™ÂÖàÁ¥ö ${targetMinutes === 0 ? 1 : targetMinutes === 5 ? 2 : 3})`);
                        }
                    }
                });
               
                // üéØ Â¶ÇÊûúÊúâËß∏ÁôºÁöÑÊèêÈÜíÔºåÂä†ÂÖ•ÊâπËôïÁêÜÈöäÂàó
                if (allTriggeredAlerts.length > 0) {
                    // ÂàùÂßãÂåñÊâπËôïÁêÜÈöäÂàó
                    if (!AppState.timeAlertBatch) {
                        AppState.timeAlertBatch = [];
                        AppState.batchTimer = null;
                    }
                   
                    // Â∞áÊñ∞Ëß∏ÁôºÁöÑÊèêÈÜíÂä†ÂÖ•ÊâπËôïÁêÜÈöäÂàó
                    AppState.timeAlertBatch.push(...allTriggeredAlerts);
                   
                    console.log(`üìù Âä†ÂÖ•ÊâπËôïÁêÜÈöäÂàó: ${allTriggeredAlerts.length} ÂÄãÊñ∞ÊèêÈÜí`);
                    console.log(`üìã ÊâπËôïÁêÜÈöäÂàóÁ∏ΩÊï∏: ${AppState.timeAlertBatch.length} ÂÄãÊèêÈÜí`);
                   
                    // Ê∏ÖÈô§ËàäÁöÑË®àÊôÇÂô®
                    if (AppState.batchTimer) {
                        clearTimeout(AppState.batchTimer);
                    }
                   
                    // Ë®≠ÁΩÆÊâπËôïÁêÜË®àÊôÇÂô®Ôºà1ÁßíÂæåËôïÁêÜÔºâ
                    AppState.batchTimer = setTimeout(() => {
                        this.processBatchedTimeAlerts();
                    }, 1000);
                }
            },
           
            // üéØ Êñ∞Â¢ûÔºöËôïÁêÜÊâπËôïÁêÜÁöÑÊôÇÈñìÊèêÈÜí
            processBatchedTimeAlerts() {
                if (!AppState.timeAlertBatch || AppState.timeAlertBatch.length === 0) return;
               
                // ÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫èÔºàÊï∏Â≠óË∂äÂ∞èÂÑ™ÂÖàÁ¥öË∂äÈ´òÔºâ
                AppState.timeAlertBatch.sort((a, b) => a.priority - b.priority);
               
                console.log(`üéØ ËôïÁêÜÊâπËôïÁêÜÊôÇÈñìÊèêÈÜíÈöäÂàóÔºåÂÖ± ${AppState.timeAlertBatch.length} ÂÄãÈ†ÖÁõÆÔºåÊåâÂÑ™ÂÖàÁ¥öÊéíÂ∫èÔºö`);
                AppState.timeAlertBatch.forEach(alert => {
                    console.log(`   ÂÑ™ÂÖàÁ¥ö ${alert.priority}: ${alert.description}`);
                });
               
                // ÊåâÈ†ÜÂ∫èÂä†ÂÖ•Èü≥ÊïàÈöäÂàó
                AppState.timeAlertBatch.forEach((alert, index) => {
                    // Á®çÂæÆÈåØÈñãÂä†ÂÖ•ÊôÇÈñìÔºåÁ¢∫‰øùÈ†ÜÂ∫èÊ≠£Á¢∫
                    setTimeout(() => {
                        AudioSystem.playTimeAlertSequence(alert.forms, alert.minutes);
                        console.log(`üéµ ÊåâÂÑ™ÂÖàÁ¥öÂä†ÂÖ•Èü≥ÊïàÈöäÂàó: ${alert.description}`);
                    }, index * 100); // ÊØèÂÄãÈñìÈöî100ms
                });
               
                // Ê∏ÖÁ©∫ÊâπËôïÁêÜÈöäÂàó
                AppState.timeAlertBatch = [];
                AppState.batchTimer = null;
            }
        };

        // Display Manager
        const DisplayManager = {
            updateDisplay() {
                const now = Utils.getHongKongTime();
                document.getElementById('currentTime').textContent = Utils.formatTime(now);
                document.getElementById('currentDate').textContent = Utils.formatDate(now);
               
                const forms = ['form1', 'form2', 'form3'];
                const sessions = ['Session1', 'Session2'];
               
                forms.forEach((form, formIndex) => {
                    sessions.forEach((session, sessionIndex) => {
                        const endTime = AppState.examTimes[`${form}End${sessionIndex + 1}`];
                        const timeDisplay = document.getElementById(`${form}${session}Time`);
                        const container = document.getElementById(`${form}${session}`);
                       
                        const timeRemaining = TimeCalculator.calculateTimeRemaining(endTime);
                       
                        if (!endTime) {
                            timeDisplay.textContent = '--:--:--';
                            container.className = container.className.replace(/warning-flash|urgent-flash|border-accent|border-warning/g, '').trim() + ' py-3 px-4 border-2 border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 transition-all rounded';
                        } else if (timeRemaining.ended) {
                            timeDisplay.textContent = timeRemaining.text;
                            container.className = 'py-3 px-4 border-2 border-accent bg-yellow-100 dark:bg-yellow-900 transition-all rounded';
                        } else {
                            timeDisplay.textContent = timeRemaining.text;
                           
                            let className = 'py-3 px-4 border-2 transition-all rounded ';
                            if (timeRemaining.totalSeconds <= 30) {
                                className += 'urgent-flash border-accent';
                            } else if (timeRemaining.totalSeconds <= 330) {
                                className += 'warning-flash border-warning';
                            } else if (timeRemaining.totalSeconds <= 930) {
                                className += 'warning-flash border-warning';
                            } else {
                                className += 'border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700';
                            }
                            container.className = className;
                        }
                    });
                });
               
                // Update time input displays
                Object.keys(AppState.examTimes).forEach(fieldId => {
                    TimePickerModal.updateDisplay(fieldId);
                });
            }
        };

        // Audio Status Manager
        const AudioStatusManager = {
            updateStatus(message, isError = false) {
                const statusElement = document.getElementById('audioStatusText');
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = isError ? 'text-red-600 dark:text-red-400' : 'text-slate-600 dark:text-slate-400';
                }
            }
        };

        // Audio Test Function
        async function testAudioSystem() {
            const button = event.target;
            const originalText = button.textContent;
           
            try {
                button.disabled = true;
                button.textContent = 'üéµ Ê∏¨Ë©¶‰∏≠...';
                AudioStatusManager.updateStatus('Ê≠£Âú®Ê∏¨Ë©¶Èü≥ÊïàÁ≥ªÁµ±...');
               
                console.log('=== ÈñãÂßãÈü≥ÊïàÁ≥ªÁµ±Ê∏¨Ë©¶ ===');
               
                // 1. ÂàùÂßãÂåñ Web Audio API
                const initSuccess = await AudioSystem.init();
                if (!initSuccess) {
                    throw new Error('Web Audio API ÂàùÂßãÂåñÂ§±Êïó');
                }
               
                console.log('‚úÖ Web Audio API ÂàùÂßãÂåñÊàêÂäü');
                AudioStatusManager.updateStatus('Web Audio API ÂàùÂßãÂåñÊàêÂäü');
               
                // 2. Ê∏¨Ë©¶Èü≥È†ªÊñá‰ª∂ËºâÂÖ•
                const testFiles = [
                    './voice/S1.mp3',
                    './voice/alarm.mp3'
                ];
               
                AudioStatusManager.updateStatus('Ê≠£Âú®ËºâÂÖ•Ê∏¨Ë©¶Èü≥È†ª...');
               
                let loadedCount = 0;
                for (const file of testFiles) {
                    try {
                        const buffer = await AudioSystem.loadAudioFile(file);
                        if (buffer) {
                            loadedCount++;
                            console.log(`‚úÖ ËºâÂÖ•ÊàêÂäü: ${file}`);
                        } else {
                            console.warn(`‚ö†Ô∏è ËºâÂÖ•Â§±Êïó: ${file}`);
                        }
                    } catch (error) {
                        console.error(`‚ùå ËºâÂÖ•ÈåØË™§ ${file}:`, error);
                    }
                }
               
                AudioStatusManager.updateStatus(`ËºâÂÖ• ${loadedCount}/${testFiles.length} ÂÄãÊ∏¨Ë©¶Èü≥È†ª`);
               
                // 3. Êí≠ÊîæÊ∏¨Ë©¶Â∫èÂàó
                if (loadedCount > 0) {
                    AudioStatusManager.updateStatus('Êí≠ÊîæÊ∏¨Ë©¶Èü≥Êïà...');
                   
                    // Êí≠Êîæ‰∏≠‰∏ÄÂπ¥Á¥öÈü≥Êïà
                    await AudioSystem.playAudioFile('./voice/S1.mp3', 0.6);
                    await new Promise(resolve => setTimeout(resolve, 300));
                   
                    // Êí≠ÊîæË≠¶Â†±ËÅ≤
                    await AudioSystem.playAudioFile('./voice/alarm.mp3', 0.6);
                   
                    console.log('‚úÖ Èü≥ÊïàÊí≠ÊîæÊ∏¨Ë©¶ÂÆåÊàê');
                    AudioStatusManager.updateStatus('‚úÖ Èü≥ÊïàÁ≥ªÁµ±Ê∏¨Ë©¶ÊàêÂäüÔºÅ');
                   
                    // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                    setTimeout(() => {
                        AudioStatusManager.updateStatus(`Èü≥ÊïàÁ≥ªÁµ±ÔºöÂ∑≤ÂàùÂßãÂåñ (${AudioSystem.audioBuffers.size} ÂÄãÈü≥È†ªÊ™îÊ°à)`);
                    }, 3000);
                   
                } else {
                    throw new Error('ÁÑ°Ê≥ïËºâÂÖ•‰ªª‰ΩïÈü≥È†ªÊñá‰ª∂');
                }
               
            } catch (error) {
                console.error('‚ùå Èü≥ÊïàÁ≥ªÁµ±Ê∏¨Ë©¶Â§±Êïó:', error);
                AudioStatusManager.updateStatus(`‚ùå Ê∏¨Ë©¶Â§±Êïó: ${error.message}`, true);
               
                // Êèê‰æõË®∫Êñ∑Âª∫Ë≠∞
                if (error.message.includes('Web Audio API')) {
                    console.log('Âª∫Ë≠∞: Ë´ãÁ¢∫‰øùÁÄèË¶ΩÂô®ÊîØÊè¥ Web Audio API');
                } else if (error.message.includes('Èü≥È†ªÊñá‰ª∂')) {
                    console.log('Âª∫Ë≠∞: Ë´ãÊ™¢Êü•Èü≥È†ªÊñá‰ª∂Ë∑ØÂæëÂíåÊ†ºÂºè');
                } else {
                    console.log('Âª∫Ë≠∞: Ë´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•ÂíåÁÄèË¶ΩÂô®Ë®≠ÂÆö');
                }
               
                setTimeout(() => {
                    AudioStatusManager.updateStatus('Èü≥ÊïàÁ≥ªÁµ±ÔºöÊ∏¨Ë©¶Â§±Êïó', true);
                }, 3000);
               
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // Global Functions
        function resetAllTimes() {
            // Clear all exam times
            Object.keys(AppState.examTimes).forEach(key => {
                AppState.examTimes[key] = '';
                document.getElementById(key).value = '';
            });
           
            AppState.alertHistory.clear();
            AppState.timeAlertHistory.clear();
           
            // Clear all timers
            AppState.timers.forEach(timer => clearInterval(timer));
            AppState.timers.clear();
           
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <div class="text-lg font-semibold">Êö´ÁÑ°ÊèêÈÜí</div>
                    <div class="text-sm mt-1">NO ALERTS</div>
                </div>
            `;
           
            DisplayManager.updateDisplay();
        }

        // Application Initialization
        function initApp() {
            try {
                // Initialize dark mode
                DarkMode.init();
               
                // Initialize displays
                DisplayManager.updateDisplay();
               
                // Preload audio files for better performance
                const audioFiles = [
                    './voice/S1.mp3',      // ‰∏≠‰∏Ä
                    './voice/S2.mp3',      // ‰∏≠‰∫å
                    './voice/S3.mp3',      // ‰∏≠‰∏â
                    './voice/alarm.mp3',   // Ë≠¶Â†±ËÅ≤
                    './voice/collect.mp3', // Êî∂Âç∑ËÅ≤
                    './voice/15mins.mp3',  // 15ÂàÜÈêò
                    './voice/5mins.mp3',   // 5ÂàÜÈêò
                    './voice/end.mp3'      // ËÄÉË©¶ÁµêÊùü
                ];
               
                // Preload audio files in background (non-blocking)
                setTimeout(() => {
                    AudioSystem.preloadAudioFiles(audioFiles);
                }, 1000);
               
                // üéØ ÂàùÂßãÂåñÈü≥ÊïàÊôÇÈñìË°®
                AudioScheduler.buildAudioSchedule();
               
                // Start main update loop
                setInterval(() => {
                    DisplayManager.updateDisplay();
                    AlertChecker.checkAndProcessAlerts();
                    // üéØ ÂÑ™ÂÖà‰ΩøÁî®È†êËôïÁêÜÁ≥ªÁµ±
                    if (AppState.scheduleBuilt) {
                        AudioScheduler.checkScheduledAudio();
                    } else {
                        // ÈôçÁ¥ö‰ΩøÁî®ËàäÁ≥ªÁµ±
                        AlertChecker.checkTimeAlerts();
                    }
                }, 1000);
               
                // Add click outside modal to close
                document.getElementById('timePickerModal').addEventListener('click', function(event) {
                    if (event.target === this) {
                        TimePickerModal.close();
                    }
                });
               
                // Add keyboard support for time input displays
                document.querySelectorAll('.time-input-display').forEach(element => {
                    element.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            this.click();
                        }
                    });
                });
               
                // Initialize Web Audio API on user interaction
                document.addEventListener('click', function initAudioOnInteraction() {
                    AudioSystem.init();
                    document.removeEventListener('click', initAudioOnInteraction);
                }, { once: true });
               
                console.log('ËÄÉË©¶Â†±ÊôÇÊèêÈÜíÁ≥ªÁµ±Â∑≤ÂàùÂßãÂåñ');
            } catch (error) {
                console.error('ÊáâÁî®Á®ãÂºèÂàùÂßãÂåñÂ§±Êïó:', error);
            }
        }

        // Error Handling
        window.addEventListener('error', (event) => {
            console.error('JavaScriptÈåØË™§:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Êú™ËôïÁêÜÁöÑPromiseÊãíÁµï:', event.reason);
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // Page Visibility API
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('ÊáâÁî®Á®ãÂºèÂ∑≤Êö´ÂÅú');
            } else {
                console.log('ÊáâÁî®Á®ãÂºèÂ∑≤ÊÅ¢Âæ©');
            }
        });
    </script>
</body>
</html>
